---
title: "Do _script_ ao pacote de R"
subtitle: "um exemplo desde a biologia"
author: "Andrea Sánchez-Tapia <br> Núcleo de Computação Científica e Geoprocessamento <br> Jardim Botânico do Rio de Janeiro"
affiliation: "R-Ladies Rio de Janeiro <br> Quarto meetup"
date: "`r format(Sys.Date(), '%d-%m-%Y')`"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(servr.daemon = TRUE)#para que no bloquee la sesión
library(xaringanthemer)
style_duo_accent(
  primary_color = "#562457",
  secondary_color = "#562457",
  colors = c(
    red = "#A70000",
    purple = "#88398a",
    orange = "#ff8811",
    green = "#136f63",
    blue = "#4B4FFF",
    white = "#FFFFFF",
    black = "#181818"
  ),
  text_bold_color = "#181818",
  header_font_google = google_font("Roboto Condensed"),
  text_font_google = google_font("Roboto Condensed", "300", "300i"),
  code_font_google = google_font("Fira Mono"), text_font_size = "25px"
)
```
### Apresentação


+ Bióloga - Universidade Nacional da Colômbia  
+ Mestre em Ecologia - UFRJ
+ Doutora em Botânica - JBRJ
+ .purple[Pós-doc - Núcleo de Computação Científica e Geoprocessamento do JBRJ]

Ecologia de comunidades vegetais, restauração ecológica, ecologia quantitativa  

__Informática da biodiversidade__, modelagem de nicho ecológico

__Ciência aberta e reprodutível__, ética na ciência de dados, ciência de dados feminista



---
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px

### Apresentação

+ Como trabalhar apenas com software _libre_? 

+ Usuária de `R` desde 2009

+ __O alvo hoje__: Executar e ensinar a fazer projetos de análise reprodutíveis. Desde o download e processamento de dados até produzir o manuscrito, relatório ou apresentação (__`rmarkdown`__, __`knitr`__)

+ R-Ladies+ Rio desde 2016 

+ Co-fundadora de .red[__¡liibre!__] com Sara Mortara (R-Ladies+ Rio): laboratório de informática da biodiversidade e reprodutibilidade em ecologia

---
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px


### Curso sobre ciência aberta e fluxos de trabalho reprodutíveis

.pull-left[
```{r, echo = FALSE, out.width= 300}
knitr::include_graphics("./figs/turma.JPG")
```


```{r, echo = F, out.width= 100}
knitr::include_graphics("./figs/logo_jbrj.png")
```
]

.pull-right[

__Boas práticas__ em análise de dados

```{r, echo = F, out.width=200}
knitr::include_graphics("./figs/rstudio.jpg")

```

```{r, echo = F, out.width= 80}
knitr::include_graphics("./figs/logo-git.png")
knitr::include_graphics("./figs/GitHub_Logo.png")
knitr::include_graphics("./figs/btibucket.png")
knitr::include_graphics("./figs/gitlab-logo-gray-rgb.png")
```

```{r, echo = F, out.width= 100}
knitr::include_graphics("./figs/latex.jpeg")
knitr::include_graphics("./figs/bibtex.jpeg")
knitr::include_graphics("./figs/zotero.svg")
```
```{r, echo = F, out.width= 50}
knitr::include_graphics("./figs/rmarkdown.png")
```

```{r, echo = F, out.width= 60}
knitr::include_graphics("./figs/xaringan.png")
```
]


 <!-- pensada como seminário
 alunes de várias áreas do conhecimento
 ferramentas que não têm um ensino formal
 de grande utilidade --> 

---
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px

### Por que a ênfase em reprodutibilidade?

+ Transparência
+ Portabilidade - colaboração!
+ Correção de erros `->` robusteza
+ Comunicação

Para criar um pacote de R precisa ser todas estas coisas

### Mas _bem antes_ de chegar ao pacote também é bom implementar estas boas práticas!


---
class: middle
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px

### Pacote de R para modelagem de nicho <br> ecológico: .red[modleR]

+ __Unificar__ diferentes partes do processo de MNE
+ Fornecer __metadados__ e __documentar__ decisões de parametrização
+ Se __integrar__ ao resto de ferramentas que existem no ambiente de `R`

<br>
```{r, echo = FALSE, out.width= 151}
knitr::include_graphics("./figs/mm.png")
```
```{r, echo = FALSE, out.width= 600}
knitr::include_graphics("./figs/coleguinhes.png")
```

<small>
Marinez F Siqueira, Sara Mortara, Diogo Rocha, Guilherme Gall, Felipe Sodré
</small>

.pull-left[

`r icon::fa("firefox")` 
<small>
[https://model-r.github.io/modleR/](https://model-r.github.io/modleR/)
</small>
]

.pull-right[
<p style="text-align:center;">

`r icon::fa("youtube")` 

<small>
<a href="https://www.youtube.com/watch?v=4Xw33TdIVXA">Aula no curso ENM-2020</a>

</small>
</p>

]

---
class: bottom, center
background-image: url("figs/modleR.png")
background-position: 50% 0%
background-size: 800px

```{r, echo = FALSE, out.width= 800}
knitr::include_graphics("./figs/preprint.png")
```


---
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px

### Modelos de nicho ecológico ou de <br> distribuição das espécies (ENM, SDM)

+ Dados de ocorrência das espécies: __objetos espaciais__, bases de dados, limpeza de dados.

+ Camadas preditoras ambientais ( __rasters__ de SIG)  Pacotes __`raster`__, __`sp`__, __`maps`__, __`rgdal`__: (taskview Spatial)  Hoje no _tidyverse_: __`sf`__

+ Abordagem de aprendizado estatístico 

+ Diferentes algoritmos
 
+ __Inferência de áreas adequadas para a ocorrência das espécies__

---
class: inverse, middle, center
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px

### A gente já conhecia algumas boas práticas



---
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px

### Boas práticas `r emojifont::emoji('heart')` <br> estrutura de pastas e pasta de trabalho 

+ _Meetup_ anterior! [link](https://www.youtube.com/watch?time_continue=1563&v=4nfIbiS1Huw&feature=emb_title) e arquivo .zip 

--

+ Não use `setwd()`! `r emojifont::emoji('fire')`

--

+ Não mude de pasta de trabalho ao longo do projeto: use __caminhos relativos__

--
    
  + Caminhos absolutos: `"C://Eu/Minha_pasta/arquivo_meu_v_13.csv"`

--

  + Caminhos relativos: `"./data"`, `"./figs"`
  
--

 + O nível acima é com dois pontos: `..`

--

 + Uma pasta "do lado" é uma subpasta desse nível acima: `"../pasta_irmã"`


---
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px

### Boas práticas `r emojifont::emoji('heart')` <br> estrutura de pastas e pasta de trabalho 

+ Cuide da estrutura de pastas
--

```bash
.
├── codigo/    # Scripts em R
├── dados/     # Dados 
├── output/    # Outputs gerados a partir dos códigos
├── figs/      # Figuras geradas a partir dos códigos
├── docs/      # Relatórios reprodutíveis a partir dos outputs
├── *.Rproj    # Projeto de RStudio
├── .gitignore # Lista dos arquivos e pastas que não serão controlados
└── README.md   
```
--

+ Abra as sessões de R já na pasta de trabalho
--

 + Um atalho: usar o pacote __rprojroot__ ou __here__
--

 + Um atalho melhor: usar projetos de .blue[RStudio]

---
class: inverse, center, middle

# A história

---
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px

### Primeira etapa: _scripts_ soltos

#### O trabalho: gerar uma camada de diversidade potencial de plantas <br> da Mata Atlântica

+ A "maior" quantidade possível de espécies
+ Muito controle sobre a qualidade dos modelos
+ Correção taxonômica, limpeza dos registros
+ Alta resolução (30s ~1km)

--

#### O fluxo de trabalho: cada espécie precisa passar por várias etapas

+ Obtenção, __limpeza__ de dados
+ Desenho experimental, __preparação__ dos dados
+ Fazer os __modelos__, __projetar__ os modelos para vários algoritmos
+ Juntar os resultados dos diferentes algoritmos
+ Juntar o resultado para várias espécies

---
### Primeira etapa: _scripts_ soltos

+ Um script para __uma__ espécie (fazia todas as etapas de vez)

--

+ Um `"for loop"` para fazer para várias espécies

```r
lista_de_especies <- c("sp1", "sp2", "sp3")
```

--

```r
for (especie in lista_de_especies) { # pode ter qualquer nome, i
    todo_o_codigo(especie)
}
```

--

```r
especie <- sp1
looop(sp1)

especie <- sp2
looop(sp2)

especie <- sp3
looop(sp3)
```


---
background-image: url('figs/hadley.jpg')
background-size: 150px
background-position: 90% 10%

### Criar funções


"Se você está copiando e colando seu código mais   
de três vezes, é hora de escrever uma função"

`Hadley Wickham`

--

```{r, eval = F}
modelar <- function(x) {
    y <- ...(x)
    return(y)
}

# Uma espécie
modelar(especie)

# Várias espécies
lapply(lista_de_especies, modelar)

purrr::map(lista_de_especies, 
           ~modelar)
```

--

#### A função ainda rodava todas as etapas da análise para cada espécie!

---
background-image: url('figs/alltest_alphamap1.png')
background-position: 95% 50%
background-size: 45%
class: inverse

### Rodava!  
--

### Matava a RAM :/
--

### Demorava 10 dias ¬¬ 
--

### Fazia uma espécie após <br> a outra

--
![](figs/felipe.png) <br> Felipe Sodré


---
background-image: url('./figs/lncc.png')
background-size: 300px
background-position: 90% 10%

### Segunda etapa

+ Capacidade de computação 
+ Computação remota (VPN, ssh)
+ __Paralelização__ 
  + Separar os quatro processos em funções diferentes
+ Escrever código em colaboração: 
  + __Começar a usar controle de versões__ (git/GitHub)
  + Cuidar do __estilo de código__ 


--


![Wa](figs/math.gif)


---
### Paralelização

+ Cada processo vai para um _core_ (os computadores de hoje têm 4 _cores_)
+ Os _clusters_ de computação podem ter várias centenas de _cores_
+ Há várias maneiras de paralelizar processos em R

```r
library(parallel)
library(snowfall)
library(foreach)
library(futures)
```

```r
sfInit(parallel = T, cpus = 3)
sfExportAll() # para que cada núcleo receba as variáveis do workspace
sfLapply(lista_de_especies, modelar)
sfStop()
```

### Passou de 10 dias para 2 horas ¬¬


---
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px

### __Modularizar__ o código

+ Cada core ainda aceitava uma especie inteira - os quatro processos 

+ E se a gente rodasse um processo por vez para todas as espécies? 

+ Na hora de repetir não precisava voltar até o início

+ Quatro funções!

---
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px
### Controle de versões: Git e GitHub

```{r, echo = F, out.width= 80}
knitr::include_graphics("./figs/logo-git.png")
knitr::include_graphics("./figs/GitHub_Logo.png")
knitr::include_graphics("./figs/btibucket.png")
knitr::include_graphics("./figs/gitlab-logo-gray-rgb.png")
```

+ Git é o programa que lida localmente
+ O GitHub é um portal remoto, existem outros (BitBucket, Gitlab)

---
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px

### Git: baseado em _snapshots_ -> o __commit__

```{r, echo = F, out.width= 400}
knitr::include_graphics("./figs/snapshots.png")
```

https://git-scm.com/book/en/v2/Getting-Started-About-Version-Control


---
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px

### Git: modo diff

```{r echo = F, out.width=600}
knitr::include_graphics("figs/diff.png")
```


https://git-scm.com/book/en/v2/Getting-Started-Git-Basics

---
# Git: local e remoto

```{r echo = F, out.width=500}
knitr::include_graphics("figs/areas.png")
```


https://git-scm.com/book/en/v2/Getting-Started-Git-Basics

---
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px
### We `r emojifont::emoji('heart')` `r knitr::include_graphics("figs/logo-git.png", dpi = 300)`


+ Backup

--

+ Controle de versões

--

+ Reprodutibilidade

--

+ Workflow colaborativo

--

+ Transparência


#### É preciso padronizar o jeito de escrever o código!*

---
background-image: url('figs/hadley.jpg')
background-size: 150px
background-position: 90% 10%

### Estilo de código

"Um bom estilo de código é como usar uma boa pontuação. <br>  Você pode viver sem ela mas sem dúvida facilita ler as coisas." 

Hadley Wickham


+ [Google's R style guide](https://google.github.io/styleguide/Rguide.html)
+ [tidyverse](https://style.tidyverse.org/)
+ [Advanced R](http://adv-r.had.co.nz/Style.html)

Independente do estilo, o que importa é ser consistente!

`Ctrl+Shift+A` Reformata o código automaticamente

pacote __formatR__ 


---
background-image: url("figs/rpackages.png")
background-size: 300px
background-position: 90% 50%

### Terceira etapa: Transformação em pacote


```{r echo = F, out.width=90}
knitr::include_graphics("figs/guilherme.png")
```
Guilherme Gall

--

+ Estrutura especial das pastas
+ Documentação específica
+ Licença
+ "Vignettes"
+ Documentação cuidadosa
+ Passar testes!
+ Submissão a CRAN _`#medo`_

--

#### Pacotes para ajudar:
+ `devtools`  
+ `roxygen2`  



---
### Estrutura de um pacote de R

```bash
.
├── R/           # Funções
├── man/         # Documentação
├── data/        # Dados
├── vignettes/   # Vignettes
├── inst/        # Os manuais que ficam quando você instala
├── .buildignore # Arquivos e pastas que não serão controlados
├── DESCRIPTION  # Descrição do pacote
├── NAMESPACE    # NAMESPACE
└── README.md    # README
```

+ O próprio pacote pode ser criado usando as opções de RStudio
+ O pacote __usethis__ (função `usethis::create_package()`)

---
### DESCRIPTION

```bash
.
├── R/           # Funções
├── man/         # Documentação
├── data/        # Dados
├── vignettes/   # Vignettes
├── inst/        # Relatórios reprodutíveis a partir dos outputs
├── .buildignore # Arquivos e pastas que não serão controlados
*├── DESCRIPTION  # Descrição do pacote
├── NAMESPACE    # NAMESPACE
└── README.md    # README
```

<small>
A DESCRIPTION do pacote é editada a mão. 
```
Package: rladiesrio
Type: Package
Title: Isto é um esqueleto de pacote de teste
Version: 0.1.0
Author: RLadies+ Rio de Janeiro
Maintainer: Andrea Sánchez-Tapia <andreasancheztapia@gmail.com>
Description: Este esqueleto permite entender a estrutura de um pacote. 
License: MIT
Encoding: UTF-8
LazyData: true
RoxygenNote: 7.1.0
```
</small>
---
### NAMESPACE

```bash
.
├── R/           # Funções
├── man/         # Documentação
├── data/        # Dados
├── vignettes/   # Vignettes
├── inst/        # Relatórios reprodutíveis a partir dos outputs
├── .buildignore # Arquivos e pastas que não serão controlados
├── DESCRIPTION  # Descrição do pacote
*├── NAMESPACE    # NAMESPACE
└── README.md    # README
```
O NAMESPACE indica quais funções serão importadas ou exportadas pelo pacote

```
*# Generated by roxygen2: do not edit by hand

export(create_buffer)
export(do_any)
import(graphics)
import(raster)
importFrom(Rdpack,reprompt)
importFrom(dismo,randomPoints)
```

---
### __roxygen2__ e a documentação das funções

```bash
.
├── R/           # Funções
*├── man/         # Documentação
├── data/        # Dados
├── vignettes/   # Vignettes
├── inst/        # Relatórios reprodutíveis a partir dos outputs
├── .buildignore # Arquivos e pastas que não serão controlados
├── .gitignore   # Arquivos e pastas que serão ignorados por git
├── *.Rproj      # Projeto de RStudio
├── DESCRIPTION  # Descrição do pacote
├── NAMESPACE    # NAMESPACE
└── README.md    # README
```

+ Antes era preciso escrever à mão a documentação, o NAMESPACE e a DESCRIPTION.
+ Hoje: os parâmetros das funções podem ser documentados diretamente nos arquivos em R/ com um método diferente: `#'` e indicando os parâmetros, e as funções de pacotes que serão usadas 

---
### __roxygen2__ e a documentação das funções

```
#' Titulo da funcao
#'
#' descricao
#'
#' @param parametro1 descrição do parâmetro1
#' @param parametro2 descrição do parâmetro2
#' @Import pacote
#' @ImportFrom pacote funcao funcao funcao
#' @details
#' @returns um data.frame
*#' @export #para que entre no NAMESPACE
#' @examples
um exemplo reprodutível, curto
funcao <- function(x) {
funfunfun
}
```
+ Opção `code > Insert Roxygen Skeleton` no menu de RStudio
+ Quando a documentação é escrita: `devtools::document()`
+ Vai criar os arquivos em man, editar o NAMESPACE

---
### Outras formas de documentação: vignettes e README

```bash
.
├── R/           # Funções
├── man/         # Documentação
├── data/        # Dados
*├── vignettes/   # Vignettes
├── inst/        # Relatórios reprodutíveis a partir dos outputs
*├── .buildignore # Aqui tem que estar README.Rmd que é um arquivo opcional
├── DESCRIPTION  # Descrição do pacote
├── NAMESPACE    # NAMESPACE
*├── README.Rmd    # README em rmarkdown que é knittado para criar o md
*└── README.md    # README
```

README e vignettes são arquivos de rmarkdown que são knittados 

```{r, echo = FALSE, out.width=100}
knitr::include_graphics("./figs/rmarkdown.png")
```

---
### Checando o pacote

+ Pacote __testthat__ para criar testes formais com expectativas (opcional)
+ Para checar se o pacote está funcionando: `devtools::load_all()` sem precisar instalar mas vai contar se pode ser usado
+ Quando o pacote foi terminado: hora dos tests! `devtools::check()`
+ Vai rodar os tests de CRAN e fazer um diagnóstico do pacote. 
+ Quando está passando tests `r emojifont::emoji('tada')`

![](figs/tests.png)

+ Pode mandar para GitHub e __o pacote pode ser instalado desde GitHub__

`remotes::install_github("Model-R/modelr_pkg", build_vignettes = TRUE)`

--

---
background-image: url("figs/usethis.png")
background-position: 98% 2%
background-size: 150px

### Fluxos automatizados : __usethis__

---
background-image: url("figs/testthat.png")
background-position: 98% 2%
background-size: 150px

### Tests formais: __testthat__

---
background-image: url("figs/pkgdown-logo.png")
background-position: 98% 2%
background-size: 150px
### Uma página para o seu pacote: __pkgdown__

```{r, echo = FALSE, out.width=350}
knitr::include_graphics("./figs/pkgdown.png")
```

+ `pkgdown::build_site()` vai knittar tudo em formato de página web e colocar em uma pasta __docs/__ do pacote
+ O repositório de GitHub tem que estar configurado para fazer uma página a partir dessa pasta
+ O readme ou um index.md serão a primeira página
+ A vignette principal irá em Get started
+ Vignettes adicionais __que não estão no pacote__ devem ir em vignettes/articles e irão na aba Articles

---
### Lições nestes anos

+ Trabalho colaborativo entre instituições e áreas do conhecimento (JBRJ, LNCC, IIS)
+ Boas perguntas
+ Limpeza de dados!
+ Paciência
+ Controle de versões, ênfase na documentação
+ Testes pelos usuários (Versão web/php OK, falta muito trabalho no teste direto do pacote)

---
# Sobre qualquer _script_ em geral

.pull-left[
`Não`
+ Use `setwd()` e a mesma sessão para diferentes projetos
+ Use pastas absolutas (`"C://Eu/Minha_pasta/"`)
+ Dependa do workspace: chega de salvar e carregar o `.RData`.
]

.pull-right[
`Sim`
+ Use os projetos de RStudio! (`.RProj`) 
+ Em vez disso `("aqui", "./subpasta","../pasta do lado")` 
+ E escreva arquivos de output e leia-os
+ Invista em aprender a usar __git__ e __github__ ou __bitbucket.__
+ Documente e comente tudo o que puder
+ Use um padrão de código (espaços, indentação, etc...)
]

---
class: center, middle

# ¡Obrigada!

`r icon::fa("paper-plane", colour = "#562457")` [andreasancheztapia@gmail.com](mailto:andreasancheztapia@gmail.com) 

`r icon::fa("twitter", colour = "#562457")` [@SanchezTapiaA](https://twitter.com/SanchezTapiaA) 

`r icon::fa("github", colour = "#562457")` `r icon::fa("gitlab", colour = "#562457")` `r icon::fa("bitbucket", colour = "#562457")` [andreasancheztapia](http://github.com/andreasancheztapia) 

`r icon::fa("r-project", colour = "#562457")` [R-Ladies+ Rio de Janeiro](https://www.meetup.com/pt-BR/rladies-rio/)


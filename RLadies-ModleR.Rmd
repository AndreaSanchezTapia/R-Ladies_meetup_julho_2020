---
title: "Do _script_ ao pacote de R"
subtitle: "um exemplo desde a biologia"
author: "Andrea Sánchez-Tapia <br> Núcleo de Computação Científica e Geoprocessamento <br> Jardim Botânico do Rio de Janeiro"
affiliation: "R-Ladies Rio de Janeiro <br> Quarto meetup"
date: "`r format(Sys.Date(), '%d-%m-%Y')`"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
class: middle
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(servr.daemon = TRUE)#para que no bloquee la sesión
library(xaringanthemer)
style_duo_accent(
  primary_color = "#562457",
  secondary_color = "#562457",
  colors = c(
    red = "#A70000",
    purple = "#88398a",
    orange = "#ff8811",
    green = "#136f63",
    blue = "#4B4FFF",
    white = "#FFFFFF",
    black = "#181818"
  ),
  text_bold_color = "#181818",
  header_font_google = google_font("Roboto Condensed"),
  text_font_google = google_font("Roboto Condensed", "300", "300i"),
  code_font_google = google_font("Fira Mono"), text_font_size = "25px"
)
```
### Apresentação


+ Bióloga - Universidade Nacional da Colômbia  
+ Mestre em Ecologia - UFRJ
+ Doutora em Botânica - JBRJ
+ .purple[Pós-doc - Núcleo de Computação Científica e Geoprocessamento do JBRJ]

Ecologia de comunidades vegetais, restauração ecológica, ecologia quantitativa  

__Informática da biodiversidade__, modelagem de nicho ecológico

__Ciência aberta e reprodutível__, ética na ciência de dados, ciência de dados feminista


---
class: middle
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px

### Apresentação

+ Como trabalhar apenas com software _libre_? 

+ Usuária de `R` desde 2009

+ __O alvo hoje__: Executar e ensinar a fazer projetos de análise reprodutíveis `r emojifont::emoji(emojifont::search_emoji('grimacing'))`. Desde o download e processamento de dados até produzir o manuscrito, relatório ou apresentação (rmarkdown, __`knitr`__)

+ Várias ferramentas adicionais: RStudio + git + google drive + SQL

---
class: middle
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px

 <!-- + "Curso de `R`" : ensino de ferramentas de computação científica `R` <br> --> 

### Curso sobre ciência aberta e fluxos de trabalho reprodutíveis

.pull-left[
```{r, echo = FALSE, out.width= 300}
knitr::include_graphics("./figs/turma.JPG")
```


```{r, echo = F, out.width= 100}
knitr::include_graphics("./figs/logo_jbrj.png")
```
]

.pull-right[

__Boas práticas__ em análise de dados

```{r, echo = F, out.width=200}
knitr::include_graphics("./figs/rstudio.jpg")

```

```{r, echo = F, out.width= 80}
knitr::include_graphics("./figs/logo-git.png")
knitr::include_graphics("./figs/GitHub_Logo.png")
knitr::include_graphics("./figs/btibucket.png")
knitr::include_graphics("./figs/gitlab-logo-gray-rgb.png")
```

```{r, echo = F, out.width= 100}
knitr::include_graphics("./figs/latex.jpeg")
knitr::include_graphics("./figs/bibtex.jpeg")
knitr::include_graphics("./figs/zotero.svg")
```
```{r, echo = F, out.width= 50}
knitr::include_graphics("./figs/rmarkdown.png")
```

```{r, echo = F, out.width= 50}
knitr::include_graphics("./figs/xaringan.png")
```
]


 <!-- pensada como seminário
 alunes de várias áreas do conhecimento
 ferramentas que não têm um ensino formal
 de grande utilidade --> 

---
class: middle
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px

### Por que a ênfase em reprodutibilidade?

+ Transparência
+ Portabilidade - colaboração!
+ Correção de erros `->` robusteza
+ Comunicação

Para criar um pacote de R precisa ser todas estas coisas

### Mas _bem antes_ de chegar ao pacote também é bom implementar estas boas práticas!


---
class: middle
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px

### Pacote de R para modelagem de nicho <br> ecológico: .red[modleR]

+ __Unificar__ diferentes partes do processo de MNE
+ Fornecer __metadados__ e __documentar__ decisões de parametrização
+ Se __integrar__ ao resto de ferramentas que existem no ambiente de `R`

<br>
```{r, echo = FALSE, out.width= 151}
knitr::include_graphics("./figs/mm.png")
```
```{r, echo = FALSE, out.width= 600}
knitr::include_graphics("./figs/coleguinhes.png")
```

<small>
Marinez F Siqueira, Sara Mortara, Diogo Rocha, Guilherme Gall, Felipe Sodré
</small>

.pull-left[

`r icon::fa("firefox")` 
<small>
[https://model-r.github.io/modleR/](https://model-r.github.io/modleR/)
</small>
]

.pull-right[
<p style="text-align:center;">

`r icon::fa("youtube")` 

<small>
<a href="https://www.youtube.com/watch?v=4Xw33TdIVXA">Aula no curso ENM-2020</a>

</small>
</p>

]

---
class: bottom, center
background-image: url("figs/modleR.png")
background-position: 50% 0%
background-size: 800px

```{r, echo = FALSE, out.width= 800}
knitr::include_graphics("./figs/preprint.png")
```


---
class: middle
background-image: url("figs/chevron.png")
background-position: 98% 2%
background-size: 150px

### Modelos de nicho ecológico (ENM, SDM)

+ Dados de ocorrência das espécies: __objetos espaciais__, bases de dados, limpeza de dados.

+ Camadas preditoras ambientais ( __rasters__ de SIG)  Pacotes __`raster`__, __`sp`__, __`maps`__, __`rgdal`__: (taskview Spatial)  Hoje no _tidyverse_: __`sf`__

+ Modelagem preditiva 

+ Diferentes algoritmos
 
+ __Inferência de áreas adequadas para a ocorrência das espécies__

---
### Modelos de nicho ecológico ou de distribuição das espécies (ENM, SDM)


<center>

```{r, eval = TRUE, message=FALSE, echo = FALSE}
library(VennDiagram)#bregaaaaa
grid.newpage()
a <- draw.triple.venn(area1 = 15, area2 = 15, area3 = 15, n12 = 3, n23 = 3, n13 = 3, 
    n123 = 1, category = c("Ecologia", "Computação", "Coleções biológicas"), lty = "blank", 
    fill = c("skyblue", "pink1", "mediumorchid"), fontfamily = "sans",cat.fontfamily = rep("sans",3),
    label.col = scales::alpha("white",0), cex = rep(5,7), cat.cex = 2, cat.default.pos = "text")
```

<\center>

---
class: inverse, center, middle

# A história

---
### Primeira etapa: _scripts_ soltos

+ Um desafio: gerar uma camada de __diversidade potencial de plantas da Mata Atlântica__

    + A "maior" quantidade possível de espécies
    + Muito controle sobre a qualidade dos modelos
    + Limpeza taxonômica, limpeza dos registros
    + Alta resolução (30s ~1km)

--
#### Pensar o fluxo de trabalho: 

Cada espécie precisa passar por várias etapas: 

+ Obtenção, __limpeza__ de dados
+ Desenho experimental, __preparação__ dos dados
+ Fazer os __modelos__, __projetar__ os modelos para vários algoritmos
+ Juntar os resultados dos diferentes algoritmos
+ Juntar o resultado para várias espécies

---
### Boas práticas `r emojifont::emoji('heart')` estrutura de pastas e pasta de trabalho 

+ _Meetup_ anterior! [link](https://www.youtube.com/watch?time_continue=1563&v=4nfIbiS1Huw&feature=emb_title) e arquivo .zip 

--

+ Não use `setwd()`! `r emojifont::emoji('fire')`

--

+ Não mude de pasta de trabalho ao longo do projeto: use __caminhos relativos__

--
    
+ Caminhos absolutos: `"C://Eu/Minha_pasta/arquivo_meu_v_13.csv"`

--

+ Caminhos relativos: `"./data"`, `"./figs"`

---
### Boas práticas `r emojifont::emoji('heart')` estrutura de pastas e pasta de trabalho 

+ Cuide da estrutura de pastas

```bash
.
├── codigo/    # Scripts em R
├── dados/     # Dados 
├── output/    # Outputs gerados a partir dos códigos
├── figs/      # Figuras geradas a partir dos códigos
├── docs/      # Relatórios reprodutíveis a partir dos outputs
├── *.Rproj    # Projeto de RStudio
├── .gitignore # Lista dos arquivos e pastas que não serão controlados
└── README.md   
```

O nível acima são dois pontos `..`

Nenhum caminho absoluto é necessário!


---
### Primeira etapa: _scripts_ soltos

+ Um script para __uma__ espécie
(fazia todas as etapas de vez)

--

+ Um _`"for loop"`_ para fazer para várias espécies

```r
lista_de_especies <- c("sp1", "sp2", "sp3")
```

--

```r
for (especie in lista_de_especies) {
    loooop(especie)
}
```

--

```r
especie <- sp1
looop(sp1)

especie <- sp2
looop(sp2)

especie <- sp3
looop(sp3)
```


---
background-image: url('figs/hadley.jpg')
background-size: 150px
background-position: 90% 10%

### Criar funções


"Se você está copiando e colando seu código mais   
de três vezes, é hora de escrever uma função"

`Hadley Wickham`

--

```{r, eval = F}
modelar <- function(x) {
    y <- ...(x)
    return(y)
}

# Uma espécie
modelar(especie)

# Várias espécies
lapply(lista_de_especies, modelar)

purrr::map(lista_de_especies, 
           ~modelar)
```

--

#### A função ainda rodava todas as etapas da análise para cada espécie!

---
background-image: url('figs/alltest_alphamap1.png')
background-position: 95% 50%
background-size: 45%
class: inverse

### Rodava!  
--

### Matava a RAM :/
--

### Demorava 10 dias ¬¬ 
--

### Fazia uma espécie após <br> a outra

--
![](figs/felipe.png) Felipe Sodré


---
background-image: url('./figs/lncc.png')
background-size: 300px
background-position: 90% 10%

# Segunda etapa

+ Capacidade de computação 
+ Computação remota (bash, VPN)
+ __Paralelização__!!! 

+ Limpar o código:
  + Separar os quatro processos em funções diferentes
  + __Começar a usar controle de versões__ (git/github)
  + Cuidar o __estilo de código__ 

--


![Wa](figs/math.gif)


---
### Paralelização

+ Cada processo vai para um _core_ (os computadores de hoje têm 4 _cores_)
+ Os _clusters_ de computação podem ter várias centenas de _cores_
+ Há várias maneiras de paralelizar processos em R

```r
library(parallel)
library(snowfall)
library(foreach)
library(futures)
```

```r
sfInit(parallel = T, cpus = 3)
sfExportAll() # para que cada núcleo receba as variávei no workspace
sfLapply(lista_de_especies, modelar)
sfStop()
```

### Passou de 10 para 2 horas ¬¬


---
### __Modularizar__ o código

Cada core aceitava uma especie inteira - os quatro processos. 

E se a gente rodasse um processo por vez para todas as espécies? 

Quatro funções

---
background-image: url("figs/git2.png")
background-size: 80%
background-position: 50% 50%

### Controle de versões: Git e GitHub



---
background-image: url("figs/distributed.png")
background-size: 500px
background-position: 90% 30%

### Git vs. GitHub

+ O GitHub é um portal remoto
+ Git é o que acontece localmente



---
### Git: baseado em _snapshots_ -> o __commit__

```{r echo = F, out.width=700}
knitr::include_graphics("figs/snapshots.png")
```

https://git-scm.com/book/en/v2/Getting-Started-About-Version-Control


---

# Git: controle de versões

```{r echo = F, out.width=800}
knitr::include_graphics("figs/diff.png")
```


https://git-scm.com/book/en/v2/Getting-Started-Git-Basics

---
# Git: local e remoto

```{r echo = F, out.width=500}
knitr::include_graphics("figs/areas.png")
```


https://git-scm.com/book/en/v2/Getting-Started-Git-Basics

---
background-image: url("figs/logo git.png")
background-position: 80% 10%
class:inverse

# We <3 git

### Backup

--

### Controle de versões

--

### Reprodutibilidade

--

### Workflow colaborativo

--

### Transparência


## É preciso padronizar o jeito de escrever o código!*

---
### Estilo de código

"Um bom estilo de código é como usar uma boa pontuação. Você pode viver sem ela mas sem dúvida facilita ler as coisas." 

Hadley Wickham


+ [Google's R style guide](https://google.github.io/styleguide/Rguide.html)
+ [tidyverse](https://style.tidyverse.org/)
+ [Advanced R](http://adv-r.had.co.nz/Style.html)

Independente do estilo, o que importa é ser consistente!

`Ctrl+Shift+A` Reformata code

pacote __formatR__ 


---
background-image: url("figs/rpackages.png")
background-size: 300px
background-position: 90% 50%

### Terceira etapa: Transformação em pacote


```{r echo = F, out.width=90}
knitr::include_graphics("figs/guilherme.png")
```
Guilherme Gall

--

+ Estrutura especial das pastas
+ Documentação específica
+ Licença
+ "Vignettes"
+ Documentação cuidadosa
+ Passar testes!
+ Submissão a CRAN _`#medo`_

--

#### Pacotes para ajudar:
+ `devtools`  
+ `roxygen2`  



---
background-image: url("figs/pastas.png")
background-size: contain

### Estrutura de um pacote de R


---

```
devtools::install_github("Model-R/modelr_pkg", build_vignettes = TRUE)
```

--

+ Está passando tests
![](figs/tests.png)
---
### Fluxos automatizados : __usethis__

---
### Tests formais: __testthat__

---
### Uma página para o seu pacote: __pkgdown__

---
### Lições nestes anos

+ Trabalho colaborativo entre instituições e áreas do conhecimento (JBRJ, LNCC, IIS)
+ Boas perguntas
+ Limpeza de dados!
+ Paciência
+ Controle de versões, ênfase na documentação
+ Testes pelos usuários (Versão web/php OK, falta muito trabalho no teste direto do pacote)

---
# Sobre qualquer _script_ em geral

.pull-left[
`Não`
+ Use `setwd()` e a mesma sessão para diferentes projetos
+ Use pastas absolutas (`"C://Eu/Minha_pasta/"`)
+ Dependa do workspace: chega de salvar e carregar o `.RData`.
]

.pull-right[
`Sim`
+ Use os projetos de RStudio! (`.RProj`) 
+ Em vez disso `("aqui", "./subpasta","../pasta do lado")` 
+ E escreva arquivos de output e leia-os
+ Invista em aprender a usar __git__ e __github__ ou __bitbucket.__
+ Documente e comente tudo o que puder
+ Use um padrão de código (espaços, indentação, etc...)
]

---
class: center, middle

# ¡Obrigada!

`r icon::fa("paper-plane", colour = "#562457")` [andreasancheztapia@gmail.com](mailto:andreasancheztapia@gmail.com) 

`r icon::fa("twitter", colour = "#562457")` [@SanchezTapiaA](https://twitter.com/SanchezTapiaA) 

`r icon::fa("github", colour = "#562457")` `r icon::fa("gitlab", colour = "#562457")` `r icon::fa("bitbucket", colour = "#562457")` [andreasancheztapia](http://github.com/andreasancheztapia) 

`r icon::fa("r-project", colour = "#562457")` [R-Ladies+ Rio de Janeiro](https://www.meetup.com/pt-BR/rladies-rio/)

